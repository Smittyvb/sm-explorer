<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SM Explorer</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        background-color: #e6fee6;
        text-align: center;
      }
      h1 {
        font-size: 3.5vw;
        font-weight: bold;
        margin: 0;
        max-height: 1.9em;
      }
      nav {
        height: 5vw;
        min-height: 1.35em;
        background-color: #79f179;
        max-height: 3em;
      }
      #usage {
        margin-top: 0.66em;
        margin-bottom: 0.66em;
        color: #007700;
        text-align: center;
      }
      #query {
        width: 66.666vw;
        height: 3rem;
        font-family: monospace;
        font-size: 1.5em;
        border: 1px solid #09ff09;
        margin-bottom: 1em;
      }
      .raw-data {
        font-family: monospace;
        color: black;
        background-color: #f7f7f7;
        box-shadow: 2px 2px 2px 0px #444;
        border: 1px solid #777;
        margin-right: 3px;
      }
      #loader {
        width: 100px;
        height: 100px;
        background-color: transparent;
        border-radius: 50%;
        animation-name: loader-rotate;
        animation-iteration-count: infinite;
        animation-duration: 2.5s;
        animation-timing-function: cubic-bezier(0.4, 0.07, 0.64, 0.92);
        margin-top: 1em;
        border: 1em solid green;
        border-top-style: double;
        margin: 0 auto;
      }
      .transaction {
        background-color: #7eff88;
        border-radius: 10px;
        width: 25em;
        max-width: 75vw;
        border: 0.2em solid black;
        margin: 0 auto 1em auto;
        text-align: left;
        padding: 1em;
      }
      .error-tx {
        text-decoration: line-through;
        background-color: #ff5151;
      }
      .username {
        font-weight: bold;
      }
      .block-number {
        float: right;
      }
      @keyframes loader-rotate { 
        from { 
          transform: rotate(0deg);
        }
        50% {
        }
        to { 
          transform: rotate(1800deg);
        }
      }
      @media (max-width: 385px) {
        h1 {
          font-size: 1.5em;
        }
        nav {
          height: 2.14285714286em;
        }
        #query {
          width: 80vw;
        }
      }
      @media (max-width: 300px) {
        h1 {
          font-size: 1em;
        }
        nav {
          height: 1.42857142857em;
        }
        #query {
          width: 94vw;
        }
      }
      @media (min-width: 1100px) {
        h1 {
          font-size: 2.25em;
        }
      }
    </style>
    <script>
      class Transaction {
        constructor(tx) {
          //the hash of the transaction
          this.id = tx.id;
          
          //some "virtual" transactions don't get put on-chain
          this.virtual = this.id.indexOf("sm_") === 0;
          
          //hash of block when the transaction occured
          this.blockID = tx.block_id;
          
          //hash of block before the transaction occured
          this.prevBlockID = tx.prev_block_id;
          
          //type of transaction, e.g. sm_open_pack, sm_find_match, sm_claim_reward, etc.
          this.type = tx.type;
          
          //player who caused the transaction to occur
          this.player = tx.player;
          
          //what is supposted to happen in the transaction
          try {
            this.data = JSON.parse(tx.data);
          } catch (e) {
            this.data = tx.data;
          }
          
          //results of performing the transaction, sometimes is null (such as for sm_claim_reward)
          try {
            this.result = JSON.parse(tx.result);
          } catch (e) {
            //lazy fix for a weird api bug
            this.result = JSON.parse(eval(tx.result));
          }
          
          //boolean, true if the transaction worked and was valid, otherwise false
          this.success = tx.success;
          
          //null if it worked, otherwise an object like {error: "It didn't work"}
          this.error = tx.error;
          
          //block number when the transaction occured
          this.block = tx.block_num;
          
          //date of when the transaction occured
          this.date = tx.created_date;
                    
          //price data as of the transaction
          this.priceData = {sbd: tx.sbd_price, steem: tx.steem_price};
          
          //original raw transaction
          this.raw = tx;
        }
        typeString() {
          var types = {
            "sm_find_match": "started looking for a match",
            "sm_open_pack": "opened a pack",
            "sm_claim_reward": "claimed a reward",
            "sm_team_reveal": "revaled their team",
            "sm_combine_all": "combined cards",
            "sm_combine_cards": "combined cards",
            "sm_gift_packs": "gifted booster packs",
            "sm_start_quest": "started a daily quest",
            "sm_sell_cards": "placed a sell order",
            "sm_cancel_sell": "cancelled a sell order",
            "sm_pack_purchase": "purchased booster packs",
            "sm_market_purchase": "bought cards on the market",
            "sm_market_sale": "fulfilled a sell order",
            "sm_gift_cards": "gifted cards",
            "sm_cancel_match": "stopped looking for a battle"
          };
          console.log(this.type);
          console.log(this);
          if (types[this.type]) return types[this.type];
          return '<span class="raw-data">' + this.type + "</span>";
        }
        summary() {
          if (this.type === "sm_pack_purchase") {
            if (this.data.type === "quest") {
              return "claimed a daily quest reward";
            }
          }
          return this.typeString();
        }
        toHTML() {
          if ((this.type === "sm_team_reveal") || (this.type === "sm_find_match")) return "";
          return `
            <div class="transaction${this.error ? " error-tx" : ""}" ${this.error ? 'title="Error: ' + this.error + '"e' : ""}>
              <span class="username">${this.player}</span>
              ${this.typeString()}
              <span class="block-number">${this.block}</span>
            </div>
          `;
        }
        toExpandedHTML() {
          //extra data about transaction
        }
      }
      window.addEventListener("load", function () {
        var updatePage = function () {
          var name = document.getElementById("query").value;
          name = name.trim();
          if (name === "") document.getElementById("content").innerHTML = "";
          fetch("https://steemmonsters.com/players/history?username=" + name + "&from_block=-1&limit=500").then(async function (result) {
            var history = await result.json();
            console.log(history);
            let html = "";
            history.forEach(function (item) {
              html += new Transaction(item).toHTML();
            });
            document.getElementById("content").innerHTML = html;
          });
        }
        document.getElementById("query").oninput = updatePage;
        document.getElementById("loader").style.display = "none";
      });
    </script>
  </head>
  <body>
    <nav>
      <h1>Steem Monsters Explorer</h1>
    </nav>
    <div id="usage">
      Enter a Steem username<!--, block number, purchase ID (starts with <span class="raw-data">P-</span>), booster pack ID (starts with <span class="raw-data">B-</span>), or battle ID-->.
    </div>
    <input type="text" id="query" />
    <div id="loader">
    </div>
    <div id="content"></div>
    By Smitop.
  </body>
</html>
